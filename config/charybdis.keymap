#include <dt-bindings/zmk/mouse.h>
#include <behaviors/mouse_keys.dtsi>
#include <behaviors.dtsi>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/pointing.h>
#include <input/processors.dtsi>

// ... (sk, lt, mt settings remain unchanged)

/ {
    // ... (existing behavior definitions remain unchanged)

    // ðŸ‘‡ ADD NEW SENSOR UTILITY BEHAVIORS FOR SCALING
    behaviors {
        // ... (existing behaviors like back_home, shift_repeat, etc. remain unchanged)

        // --- NEW TRACKBALL BEHAVIORS ---

        // Standard Speed (4/5 scaling)
        sensor_standard: sensor_standard {
            compatible = "zmk,behavior-sensor-util";
            sensor-id = <&vtrackball>;
            bindings = <&sensor_util_mouse_move 4 5>; // (4 / 5) = 0.8 scale
        };

        // Snipe Speed (1/6 scaling)
        sensor_snipe: sensor_snipe {
            compatible = "zmk,behavior-sensor-util";
            sensor-id = <&vtrackball>;
            bindings = <&sensor_util_mouse_move 1 6>; // (1 / 6) = ~0.16 scale
        };

        // Scroll Speed (1/14 scaling for scroll, replacing ib_wheel_scaler)
        sensor_scroll_scaler: sensor_scroll_scaler {
            compatible = "zmk,behavior-sensor-util";
            sensor-id = <&vtrackball>;
            bindings = <&sensor_util_mouse_scroll 1 14>; // (1 / 14) scale
        };

        // ... (existing behavior definitions continue)
    };
    
    // --- TRACKBALL LISTENERS (CLEANED) ---

    /* input config for mouse move mode */
    trackball_listener {
        compatible = "zmk,input-listener";
        device = <&vtrackball>;
        
        // REPLACED 'layers' property with &zip_conditional_layer input processor
        // which matches old functionality but uses the new syntax.
        // The old functionality was likely 'activate layer 7 when layer 0 is active'
        // &zip_conditional_layer <target_layer> <condition_layer>
        input-processors = <&zip_conditional_layer 7 0>; 
        
        evt-type = <INPUT_EV_REL>;
        x-input-code = <INPUT_REL_X>;
        y-input-code = <INPUT_REL_Y>;
        
        // DEPRECATED PROPERTIES REMOVED: layers, scale-multiplier, scale-divisor
    };

    /* input config for snipe mode */
    trackball_snipe_listener {
        compatible = "zmk,input-listener";
        device = <&vtrackball>;
        
        // REPLACED 'layers' property with &zip_conditional_layer
        // Activate layer 5 when layer 5 is active (meaning: use this listener when on layer 5)
        input-processors = <&zip_conditional_layer 5 5>;
        
        evt-type = <INPUT_EV_REL>;
        x-input-code = <INPUT_REL_X>;
        y-input-code = <INPUT_REL_Y>;
        
        // DEPRECATED PROPERTIES REMOVED: layers, scale-multiplier, scale-divisor
    };

    /* input config for mouse scroll mode */
    trackball_scroll_listener {
        compatible = "zmk,input-listener";
        device = <&vtrackball>;
        
        // REPLACED 'layers' property with &zip_conditional_layer
        // Activate layer 6 OR 2 based on movement when one of them is active.
        // This old usage is ambiguous, using zip_conditional_layer for the primary layer (2) for simplicity.
        // Use &zip_conditional_layer 2 2 if you only want the listener active on layer 2.
        // For the old 'layers = <2 6>', it means this listener is active on both. 
        // ZMK does not have a single processor for OR conditions, so we'll use layer 2 and adjust keymap.
        input-processors = <&zip_conditional_layer 2 2>;
        
        evt-type = <INPUT_EV_REL>;
        x-input-code = <INPUT_REL_MISC>;
        y-input-code = <INPUT_REL_WHEEL>;
        y-invert;
        
        // REPLACED 'bindings = <&ib_wheel_scaler 1 14>;' 
        // Scroll scaling must be handled via the keymap now. REMOVED.
    };

    // DEPRECATED NODES REMOVED:
    // ib_wheel_scaler: ib_wheel_scaler { ... } 
    // ib_toggle_layer: ib_toggle_layer { ... }
    
    // ... (existing combos and macros remain unchanged)
    
    keymap {
        compatible = "zmk,keymap";

        // --- KEYMAP FIXES: ADD SENSOR UTILS TO LAYERS ---

        BASE {
            bindings = <
// ... first row ...
&none  &mt LC(Q) Q  &kp L  &kp Y             &kp P          &kp B                      &kp Z           &kp F        &kp O        &kp U        &kp SLASH  &none
&none  &kp C        &kp R  &lt 2 S           &mt LSHIFT T   &kp G                      &kp M           &kp N        &kp E        &kp I        &kp A      &none
&none  &kp W        &kp J  &lt 5 V           &kp D          &kp K                      &kp X           &lt 6 H        &lt 6 COMMA    &kp PERIOD   &kp APOS   &none
                     &mt LCTRL SPACE &kp TAB             &mt LC(LEFT_SHIFT) LC(TAB) &sk LEFT_SHIFT &key_repeat
            >;
            // ðŸ‘‡ ADD STANDARD SPEED SENSOR UTILITY TO BASE LAYER
            sensor-bindings = <&sensor_standard>;
        };

        // ... (Layer 'num' 1, Layer 'NAV' 3, Layer 'switch' 4, Layer 'functionkey' 8 remain unchanged)

        // NAV is Layer 2 (from the lt 2 S binding)
        NAV {
            bindings = <
// ...
            >;
            // ðŸ‘‡ ADD SCROLL SPEED SENSOR UTILITY TO LAYER 2 (NAV/SCROLL)
            sensor-bindings = <&sensor_scroll_scaler>;
        };

        // snipe is Layer 5 (from the lt 5 V binding)
        snipe {
            bindings = <
&trans  &trans  &trans  &trans  &trans  &trans    &trans  &trans  &trans  &trans  &trans  &trans
&trans  &trans  &mo 7   &trans  &trans  &trans    &trans  &trans  &trans  &trans  &trans  &trans
&trans  &trans  &trans  &trans  &trans  &trans    &trans  &trans  &trans  &trans  &trans  &trans
                        &trans  &trans  &trans    &trans  &trans
            >;
            // ðŸ‘‡ ADD SNIPE SPEED SENSOR UTILITY TO LAYER 5 (SNIPE)
            sensor-bindings = <&sensor_snipe>;
        };

        // scroll is Layer 6 (from the lt 6 H/COMMA binding)
        scroll {
            bindings = <
&trans  &trans  &trans  &trans  &trans  &trans    &trans    &trans    &trans  &trans  &trans  &trans
&trans  &trans  &trans  &trans  &trans  &trans    &trans    &trans    &trans  &mo 7   &trans  &trans
&trans  &trans  &trans  &trans  &trans  &trans    &trans    &trans    &trans  &trans  &trans  &trans
                        &trans  &trans  &trans    &mkp MB4  &mkp MB5
            >;
            // ðŸ‘‡ ADD SCROLL SPEED SENSOR UTILITY TO LAYER 6 (SCROLL)
            sensor-bindings = <&sensor_scroll_scaler>;
        };

        // ... (other layers remain unchanged)
    };
};
